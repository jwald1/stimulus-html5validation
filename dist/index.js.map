{"version":3,"file":"index.js","sources":["../src/error.js","../src/validator.js","../src/index.js"],"sourcesContent":["const defaultMessages = {\n  badInput: \"is invalid\",\n  patternMismatch: \"doesn't match %{pattern}\",\n  rangeOverflow: \"must be less than %{max}\",\n  rangeUnderflow: \"must be greater than %{min}\",\n  stepMismatch: \"number is not divisible by %{step}\",\n  tooLong: \"is too long (maximum is %{maxLength} characters)\",\n  tooShort: \"is too short (minimum is %{minLength} characters)\",\n  typeMismatch: \"is not a valid %{type}\",\n  valueMissing: \"can't be blank\",\n}\n\nconst customMessageAttribute = {\n  badInput: \"is invalid\",\n  patternMismatch: \"patternValidationMessage\",\n  rangeOverflow: \"maxValidationMessage\",\n  rangeUnderflow: \"minValidationMessage\",\n  stepMismatch: \"stepValidationMessage\",\n  tooLong: \"maxlengthValidationMessage\",\n  tooShort: \"minlengthValidationMessage\",\n  typeMismatch: \"typeValidationMessage\",\n  valueMissing: \"requiredValidationMessage\",\n}\n\nexport default class {\n  constructor(el) {\n    this.el = el\n    this.errorType = this.errorType()\n  }\n\n  message() {\n    if (this.el.validity.valid) {\n      return\n    }\n\n    return this.customMessage() || this.defaultMessage()\n  }\n\n  // private\n\n  customMessage() {\n    const dataAttribute = customMessageAttribute[this.errorType]\n\n    return this.el.dataset[dataAttribute]\n  }\n\n  errorType() {\n    const errorTypes = Object.keys(defaultMessages)\n    for (let index = 0; index < errorTypes.length; index++) {\n      if (this.el.validity[errorTypes[index]]) {\n        return errorTypes[index]\n      }\n    }\n  }\n\n  defaultMessage() {\n    const message = defaultMessages[this.errorType]\n\n    return message.replace(/\\%\\{(.*)}/, (_, match) => {\n      return this.el[match]\n    })\n  }\n}\n","import ErrorMessage from \"./error\"\nconst debounce = require(\"lodash.debounce\")\n\nexport default class {\n  constructor(form, callback, debounceMs = 150) {\n    this.form = form\n    this.callback = callback\n    this.debounceMs = debounceMs\n\n    this.allFields().forEach(this.registerField)\n  }\n\n  destroy() {\n    this.allFields().forEach(this.deregisterField)\n  }\n\n  registerField = el => {\n    this.registerDergisterField(el, true)\n  }\n\n  deregisterField = el => {\n    this.registerDergisterField(el, false)\n  }\n\n  // private\n\n  registerDergisterField(el, bool) {\n    const action = bool ? \"addEventListener\" : \"removeEventListener\"\n\n    if (el.dataset.noValidate) {\n      return\n    }\n\n    if (el.nodeName === \"INPUT\") {\n      el[action](\"blur\", this.validateOnBlur)\n    }\n\n    el[action](\"input\", debounce(this.validate, this.debounceMs))\n    el[action](\"invalid\", this.validate)\n  }\n\n  validateOnBlur = e => {\n    e.target.dataset.visited = true\n\n    this.validate(e)\n  }\n\n  validate = e => {\n    e.preventDefault()\n\n    this.callback(e, {\n      error: this.errorMessage(e.target),\n      shouldDisplay: this.shouldValidate(e),\n    })\n  }\n\n  errorMessage(el) {\n    return new ErrorMessage(el).message()\n  }\n\n  shouldValidate(e) {\n    const { target } = e\n\n    if (\n      target.nodeName === \"INPUT\" &&\n      target.dataset.visited !== \"true\" &&\n      e.type !== \"invalid\" &&\n      !target.validity.valid\n    ) {\n      return false\n    }\n\n    return true\n  }\n\n  inputFields() {\n    return Array.from(this.form.querySelectorAll(\"input\")).filter(\n      el => el.type !== \"hidden\" && el.type !== \"submit\"\n    )\n  }\n\n  allFields() {\n    return Array.from(this.form.querySelectorAll(\"select, textarea\")).concat(\n      this.inputFields()\n    )\n  }\n}\n","import { Controller } from \"stimulus\"\nimport Validator from \"./validator\"\n\nexport default class extends Controller {\n  static targets = [\"submitButton\"]\n\n  connect() {\n    this.toggleDisableOnSubmitButton(true)\n    this.submitButtonTarget.addEventListener(\"click\", this.removeNoValidate)\n    this.validator = new Validator(\n      this.form,\n      this.validationCallback,\n      this.data.get(\"debounce\")\n    )\n  }\n\n  disconnect() {\n    this.submitButtonTarget.removeEventListener(\"click\", this.removeNoValidate)\n    this.validator.destroy()\n  }\n\n  get form() {\n    if (this.element.nodeName === \"FORM\") {\n      return this.element\n    } else {\n      return this.element.querySelector(\"form\")\n    }\n  }\n\n  isValid() {\n    this.data.set(\"noValidate\", true)\n    return this.form.checkValidity()\n  }\n\n  registerField = el => this.validator.registerField(el)\n  deregisterField = el => this.validator.deregisterField(el)\n\n  display(object) {\n    // overwrite\n  }\n\n  // private\n\n  removeNoValidate = () => {\n    this.data.delete(\"noValidate\")\n  }\n\n  focusFirstInput(e) {\n    if (this.data.get(\"focusOnError\") === \"false\" || e.type !== \"invalid\") {\n      return\n    }\n\n    const firstInputSelector = [\n      \"text\",\n      \"email\",\n      \"password\",\n      \"search\",\n      \"tel\",\n      \"url\",\n    ].map(type => `input[type=\"${type}\"]:invalid`)\n\n    this.form.querySelector(firstInputSelector.join(\",\")).focus()\n  }\n\n  toggleDisableOnSubmitButton(error) {\n    if (this.data.get(\"disableSubmit\") === \"false\") {\n      return\n    }\n\n    if (error) {\n      this.submitButtonTarget.disabled = true\n    } else if (this.isValid()) {\n      this.submitButtonTarget.disabled = false\n    }\n  }\n\n  validationCallback = (event, { error, shouldDisplay }) => {\n    if (event.type === \"invalid\" && this.data.has(\"noValidate\")) {\n      return\n    }\n\n    this.focusFirstInput(event)\n    this.toggleDisableOnSubmitButton(error)\n\n    if (shouldDisplay) {\n      this.display({ el: event.target, error })\n    }\n  }\n}\n"],"names":["defaultMessages","badInput","patternMismatch","rangeOverflow","rangeUnderflow","stepMismatch","tooLong","tooShort","typeMismatch","valueMissing","customMessageAttribute","el","errorType","validity","valid","customMessage","defaultMessage","dataAttribute","dataset","errorTypes","Object","keys","index","length","message","replace","_","match","debounce","require","form","callback","debounceMs","registerDergisterField","e","target","visited","validate","preventDefault","error","errorMessage","shouldDisplay","shouldValidate","allFields","forEach","registerField","deregisterField","bool","action","noValidate","nodeName","validateOnBlur","ErrorMessage","type","Array","from","querySelectorAll","filter","concat","inputFields","validator","data","delete","event","has","focusFirstInput","toggleDisableOnSubmitButton","display","submitButtonTarget","addEventListener","removeNoValidate","Validator","validationCallback","get","removeEventListener","destroy","set","checkValidity","object","firstInputSelector","map","querySelector","join","focus","disabled","isValid","element","Controller"],"mappings":"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"}